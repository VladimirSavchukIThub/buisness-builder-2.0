{% extends "base.html" %}

{% block title %}Результаты расчета - Бизнес Конструктор{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}">
<style>
    /* Стили для раздела прогноза окупаемости */
    .roi-prediction .card {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .roi-prediction .card:hover {
        transform: translateY(-5px);
    }
    
    .roi-prediction table {
        margin-bottom: 0;
    }
    
    .roi-prediction th {
        font-weight: 600;
    }
    
    .factors-list {
        padding-left: 0;
        list-style-type: none;
    }
    
    .factors-list li {
        border-bottom: 1px solid #eee;
        padding: 10px 0;
    }
    
    .factors-list li:last-child {
        border-bottom: none;
    }
    
    .factors-list li strong {
        display: block;
        margin-bottom: 5px;
        color: #0d6efd;
    }
    
    .factors-list li p {
        margin-bottom: 0;
        font-size: 0.9rem;
    }
    
    /* Стили для раздела анализа рисков */
    .risk-analysis .card {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Матрица рисков */
    .risk-matrix-container {
        padding: 15px;
        position: relative;
    }
    
    .risk-matrix {
        display: grid;
        grid-template-columns: 80px 1fr 1fr 1fr;
        grid-template-rows: 40px 1fr 1fr 1fr;
        position: relative;
        margin-bottom: 20px;
    }
    
    .risk-matrix-header-row {
        display: contents;
    }
    
    .risk-matrix-row {
        display: contents;
    }
    
    .risk-matrix-header-cell {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        background-color: #f8f9fa;
        padding: 8px;
        font-size: 0.85rem;
        z-index: 1;
    }
    
    .risk-matrix-corner {
        background-color: #fff;
    }
    
    .risk-matrix-cell {
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 10px;
        font-size: 0.85rem;
        font-weight: 500;
        border: 1px solid rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .risk-matrix-cell:hover {
        transform: scale(1.05);
        z-index: 5;
    }
    
    .risk-matrix-vertical-label {
        position: absolute;
        left: -40px;
        top: 50%;
        transform: translateY(-50%) rotate(-90deg);
        font-weight: bold;
        font-size: 0.85rem;
        color: #495057;
    }
    
    .risk-matrix-horizontal-label {
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        font-weight: bold;
        font-size: 0.85rem;
        color: #495057;
    }
    
    /* Цвета рисков */
    .risk-very-low {
        background-color: #d1e7dd;
        color: #0f5132;
    }
    
    .risk-low {
        background-color: #d1ecf1;
        color: #055160;
    }
    
    .risk-medium {
        background-color: #fff3cd;
        color: #664d03;
    }
    
    .risk-high {
        background-color: #f8d7da;
        color: #842029;
    }
    
    .risk-critical {
        background-color: #dc3545;
        color: white;
    }
    
    /* Легенда рисков */
    .risk-legend {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .risk-legend-item {
        display: flex;
        align-items: center;
        font-size: 0.75rem;
    }
    
    .risk-legend-color {
        width: 15px;
        height: 15px;
        margin-right: 5px;
        border-radius: 2px;
    }
    
    /* Аккордеон с рисками */
    .risk-details .accordion-button {
        padding: 0.75rem 1rem;
    }
    
    .risk-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        margin-right: 10px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .risk-details .accordion-body {
        padding: 1rem;
        font-size: 0.9rem;
    }
    
    /* Общая оценка рисков */
    .risk-summary-card {
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 0.25rem;
        background-color: #f8f9fa;
        margin-top: 20px;
    }
    
    .risk-summary-header {
        background-color: #343a40;
        color: white;
        padding: 10px 15px;
        border-radius: 0.25rem 0.25rem 0 0;
    }
    
    .risk-summary-header h5 {
        margin: 0;
    }
    
    .risk-summary-body {
        padding: 15px;
    }
    
    .risk-meter-container {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
    
    .risk-meter {
        width: 80%;
        position: relative;
    }
    
    .risk-meter-scale {
        display: flex;
        height: 20px;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .risk-meter-segment {
        flex: 1;
    }
    
    .risk-meter-segment.very-low {
        background-color: #d1e7dd;
    }
    
    .risk-meter-segment.low {
        background-color: #d1ecf1;
    }
    
    .risk-meter-segment.medium {
        background-color: #fff3cd;
    }
    
    .risk-meter-segment.high {
        background-color: #f8d7da;
    }
    
    .risk-meter-segment.critical {
        background-color: #dc3545;
    }
    
    .risk-meter-indicator {
        position: absolute;
        top: -15px;
        width: 10px;
        height: 30px;
        background-color: #000;
        transform: translateX(-50%);
    }
    
    .risk-meter-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .risk-conclusion {
        margin-top: 15px;
        font-size: 0.95rem;
        text-align: center;
    }
    
    .risk-strategies {
        margin-top: 20px;
    }
    
    .risk-strategies h6 {
        margin-bottom: 15px;
    }
    
    .strategy-card {
        text-align: center;
        padding: 10px;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 0.25rem;
        margin-bottom: 10px;
        background-color: white;
    }
    
    .strategy-icon {
        font-size: 1.5rem;
        margin-bottom: 5px;
        color: #0d6efd;
    }
    
    .strategy-name {
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    /* Стили для раздела интеграции с банками */
    .bank-integration .card {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border: none;
    }
    
    .bank-list {
        max-height: 350px;
        overflow-y: auto;
    }
    
    .bank-item {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }
    
    .bank-item:hover {
        background-color: #f8f9fa;
    }
    
    .bank-item:last-child {
        border-bottom: none;
    }
    
    .bank-logo {
        width: 40px;
        height: 40px;
        object-fit: contain;
        background-color: #fff;
        border-radius: 4px;
        padding: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .bank-name {
        font-weight: 600;
        margin-bottom: 2px;
    }
    
    .bank-rate {
        color: #0d6efd;
        font-weight: 700;
    }
    
    .bank-term {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    /* Кредитный калькулятор */
    .loan-result-item {
        margin-bottom: 1rem;
        padding: 10px;
        border-radius: 4px;
        background-color: #f8f9fa;
    }
    
    .loan-result-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 2px;
    }
    
    .loan-result-value {
        font-weight: 700;
        font-size: 1.1rem;
        color: #0d6efd;
    }
    
    .loan-results-title {
        position: relative;
        padding-bottom: 10px;
    }
    
    .loan-results-title:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 50px;
        height: 3px;
        background-color: #0d6efd;
    }
    
    /* Сравнение кредитов */
    .loan-comparison th {
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .loan-comparison td {
        vertical-align: middle;
    }
    
    .loan-comparison .best-option {
        background-color: rgba(25, 135, 84, 0.1);
    }
    
    .loan-comparison .best-option td:first-child {
        position: relative;
    }
    
    .loan-comparison .best-option td:first-child:before {
        content: '\f005';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        left: 5px;
        font-size: 0.7rem;
        color: gold;
    }
</style>
{% endblock %}

{% block content %}
<div class="result-container" data-aos="fade-up">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card result-card shadow-lg">
                <div class="card-header bg-success text-white p-4">
                    <h2 class="mb-0"><i class="fas fa-check-circle me-2"></i>Ваш бизнес-план готов!</h2>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-success mb-4" role="alert">
                        <i class="fas fa-info-circle me-2"></i> Ваш бизнес-план был успешно рассчитан. Ниже представлены детали вашего проекта.
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h3 class="mb-4">Детали бизнес-проекта</h3>
                            
                            <div class="details-container">
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-store"></i>
                                    </div>
                                    <div class="detail-content">
                                        <h5>Тип бизнеса</h5>
                                        <p>{{ result.business_type }}</p>
                                    </div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-expand-arrows-alt"></i>
                                    </div>
                                    <div class="detail-content">
                                        <h5>Размер бизнеса</h5>
                                        <p>{{ result.business_size }}</p>
                                    </div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-list-ul"></i>
                                    </div>
                                    <div class="detail-content">
                                        <h5>Выбранные функции</h5>
                                        {% if result.features %}
                                        <ul class="feature-list">
                                            {% for feature in result.features %}
                                            <li>{{ feature }}</li>
                                            {% endfor %}
                                        </ul>
                                        {% else %}
                                        <p>Дополнительные функции не выбраны</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="price-summary" style="background-color: #0d6efd;">
                                <div class="price-header">
                                    <h3>Итоговая стоимость</h3>
                                </div>
                                <div class="price-value animated-price" style="color: white;">
                                    {{ result.price|number_format }} руб.
                                </div>
                                <div class="price-info">
                                    <p><i class="fas fa-info-circle me-2"></i>Полная стоимость запуска бизнес-проекта</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="recommendations mt-4">
                        <h3 class="mb-3">Рекомендации</h3>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="recommendation-card">
                                    <div class="recommendation-icon">
                                        <i class="fas fa-rocket"></i>
                                    </div>
                                    <h5>Запуск</h5>
                                    <p>Оптимальный срок запуска: <strong>2-3 месяца</strong></p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="recommendation-card">
                                    <div class="recommendation-icon">
                                        <i class="fas fa-hand-holding-usd"></i>
                                    </div>
                                    <h5>Окупаемость</h5>
                                    <p>Ожидаемый срок окупаемости: <strong>12-18 месяцев</strong></p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="recommendation-card">
                                    <div class="recommendation-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h5>Персонал</h5>
                                    <p>Рекомендуемый штат: <strong>5-7 человек</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cost-breakdown mt-4">
                        <h3 class="mb-3">Детализация расходов</h3>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Категория затрат</th>
                                        <th>Сумма (руб.)</th>
                                        <th>Доля (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set total = result.price %}
                                    {% if result.cost_breakdown %}
                                        {% for category, amount in result.cost_breakdown.items() %}
                                        <tr>
                                            <td>{{ category }}</td>
                                            <td>{{ amount|number_format }}</td>
                                            <td>{{ ((amount / total) * 100)|round(1) }}%</td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        {% set equipment_cost = (total * 0.35)|round|int %}
                                        {% set rent_cost = (total * 0.15)|round|int %}
                                        {% set personnel_cost = (total * 0.25)|round|int %}
                                        {% set marketing_cost = (total * 0.10)|round|int %}
                                        {% set other_cost = total - equipment_cost - rent_cost - personnel_cost - marketing_cost %}
                                        <tr>
                                            <td>Оборудование и техника</td>
                                            <td>{{ equipment_cost|number_format }}</td>
                                            <td>35%</td>
                                        </tr>
                                        <tr>
                                            <td>Аренда помещения</td>
                                            <td>{{ rent_cost|number_format }}</td>
                                            <td>15%</td>
                                        </tr>
                                        <tr>
                                            <td>Персонал и зарплаты</td>
                                            <td>{{ personnel_cost|number_format }}</td>
                                            <td>25%</td>
                                        </tr>
                                        <tr>
                                            <td>Маркетинг и реклама</td>
                                            <td>{{ marketing_cost|number_format }}</td>
                                            <td>10%</td>
                                        </tr>
                                        <tr>
                                            <td>Прочие расходы</td>
                                            <td>{{ other_cost|number_format }}</td>
                                            <td>15%</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                                <tfoot class="table-secondary">
                                    <tr>
                                        <th>Итого</th>
                                        <th>{{ result.price|number_format }}</th>
                                        <th>100%</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-8 offset-md-2">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-info-circle me-2"></i>Важная информация
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">
                                            Представленная разбивка стоимости отражает приблизительное распределение затрат для выбранного типа бизнеса. 
                                            Фактические расходы могут отличаться в зависимости от региона, выбранных поставщиков и текущих рыночных условий.
                                        </p>
                                        <p class="card-text mb-0">
                                            Более подробный анализ расходов доступен в PDF-версии бизнес-плана.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="roi-prediction mt-4">
                        <h3 class="mb-3">Прогноз окупаемости инвестиций</h3>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Ключевые показатели окупаемости</h5>
                                    </div>
                                    <div class="card-body">
                                        {% set total_investment = result.price %}
                                        {% set monthly_revenue = (total_investment * 0.15)|round|int %}
                                        {% set monthly_expenses = (monthly_revenue * 0.7)|round|int %}
                                        {% set monthly_profit = monthly_revenue - monthly_expenses %}
                                        {% set months_to_roi = (total_investment / monthly_profit)|round|int %}
                                        
                                        <table class="table table-hover">
                                            <tbody>
                                                <tr>
                                                    <th>Общие инвестиции</th>
                                                    <td class="text-end">{{ total_investment|number_format }} руб.</td>
                                                </tr>
                                                <tr>
                                                    <th>Прогнозируемый ежемесячный доход</th>
                                                    <td class="text-end">{{ monthly_revenue|number_format }} руб.</td>
                                                </tr>
                                                <tr>
                                                    <th>Прогнозируемые ежемесячные расходы</th>
                                                    <td class="text-end">{{ monthly_expenses|number_format }} руб.</td>
                                                </tr>
                                                <tr>
                                                    <th>Прогнозируемая ежемесячная прибыль</th>
                                                    <td class="text-end">{{ monthly_profit|number_format }} руб.</td>
                                                </tr>
                                                <tr class="table-primary">
                                                    <th>Расчетный срок окупаемости</th>
                                                    <td class="text-end fw-bold">{{ months_to_roi }} месяцев</td>
                                                </tr>
                                                <tr>
                                                    <th>Прогнозируемая годовая доходность (ROI)</th>
                                                    <td class="text-end">{{ ((monthly_profit * 12 / total_investment) * 100)|round|int }}%</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Факторы, влияющие на окупаемость</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="factors-list">
                                            <li>
                                                <strong>Расположение</strong>
                                                <p>Выбор правильного местоположения может сократить срок окупаемости на 20-30%</p>
                                            </li>
                                            <li>
                                                <strong>Маркетинговая стратегия</strong>
                                                <p>Эффективная маркетинговая стратегия обеспечивает более быстрый рост клиентской базы</p>
                                            </li>
                                            <li>
                                                <strong>Сезонность</strong>
                                                <p>Учитывайте сезонные колебания спроса при планировании денежных потоков</p>
                                            </li>
                                            <li>
                                                <strong>Конкурентная среда</strong>
                                                <p>Анализ конкурентов поможет выбрать правильное позиционирование на рынке</p>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Примечание:</strong> Расчет основан на среднерыночных показателях и может отличаться в зависимости от региона и текущей экономической ситуации. Рекомендуется провести дополнительный анализ с учетом специфики вашего бизнеса.
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="risk-analysis mt-4">
                        <h3 class="mb-3">Анализ рисков</h3>
                        
                        <div class="row mb-4">
                            <div class="col-md-7">
                                <div class="card h-100">
                                    <div class="card-header bg-danger text-white">
                                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Матрица рисков</h5>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="risk-matrix-container">
                                            <div class="risk-matrix">
                                                <!-- Заголовки матрицы -->
                                                <div class="risk-matrix-header-row">
                                                    <div class="risk-matrix-header-cell risk-matrix-corner"></div>
                                                    <div class="risk-matrix-header-cell">Низкая</div>
                                                    <div class="risk-matrix-header-cell">Средняя</div>
                                                    <div class="risk-matrix-header-cell">Высокая</div>
                                                </div>
                                                
                                                <!-- Строки матрицы -->
                                                <div class="risk-matrix-row">
                                                    <div class="risk-matrix-header-cell">Высокая</div>
                                                    <div class="risk-matrix-cell risk-medium" data-risk="market">Рыночные</div>
                                                    <div class="risk-matrix-cell risk-high" data-risk="financial">Финансовые</div>
                                                    <div class="risk-matrix-cell risk-critical" data-risk="operational">Операционные</div>
                                                </div>
                                                
                                                <div class="risk-matrix-row">
                                                    <div class="risk-matrix-header-cell">Средняя</div>
                                                    <div class="risk-matrix-cell risk-low" data-risk="legal">Юридические</div>
                                                    <div class="risk-matrix-cell risk-medium" data-risk="reputation">Репутационные</div>
                                                    <div class="risk-matrix-cell risk-high" data-risk="compliance">Регуляторные</div>
                                                </div>
                                                
                                                <div class="risk-matrix-row">
                                                    <div class="risk-matrix-header-cell">Низкая</div>
                                                    <div class="risk-matrix-cell risk-very-low" data-risk="environmental">Экологические</div>
                                                    <div class="risk-matrix-cell risk-low" data-risk="personal">Персональные</div>
                                                    <div class="risk-matrix-cell risk-medium" data-risk="supply">Логистические</div>
                                                </div>
                                                
                                                <!-- Подписи осей -->
                                                <div class="risk-matrix-vertical-label">Вероятность</div>
                                                <div class="risk-matrix-horizontal-label">Влияние</div>
                                            </div>
                                            
                                            <div class="risk-legend mt-2">
                                                <div class="risk-legend-item">
                                                    <div class="risk-legend-color risk-very-low"></div>
                                                    <div class="risk-legend-text">Очень низкий</div>
                                                </div>
                                                <div class="risk-legend-item">
                                                    <div class="risk-legend-color risk-low"></div>
                                                    <div class="risk-legend-text">Низкий</div>
                                                </div>
                                                <div class="risk-legend-item">
                                                    <div class="risk-legend-color risk-medium"></div>
                                                    <div class="risk-legend-text">Средний</div>
                                                </div>
                                                <div class="risk-legend-item">
                                                    <div class="risk-legend-color risk-high"></div>
                                                    <div class="risk-legend-text">Высокий</div>
                                                </div>
                                                <div class="risk-legend-item">
                                                    <div class="risk-legend-color risk-critical"></div>
                                                    <div class="risk-legend-text">Критический</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-5">
                                <div class="card h-100">
                                    <div class="card-header bg-dark text-white">
                                        <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Ключевые риски и меры по снижению</h5>
                                    </div>
                                    <div class="card-body risk-details p-0">
                                        <div class="accordion" id="riskAccordion">
                                            <!-- Операционные риски -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="operationalRiskHeading">
                                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#operationalRiskCollapse" aria-expanded="true" aria-controls="operationalRiskCollapse">
                                                        <span class="risk-badge risk-critical">Критический</span> Операционные риски
                                                    </button>
                                                </h2>
                                                <div id="operationalRiskCollapse" class="accordion-collapse collapse show" aria-labelledby="operationalRiskHeading" data-bs-parent="#riskAccordion">
                                                    <div class="accordion-body">
                                                        <p><strong>Описание:</strong> Сбои в ключевых операционных процессах, нехватка ресурсов, проблемы с поставщиками.</p>
                                                        <p><strong>Меры:</strong> Разработка резервных планов, диверсификация поставщиков, внедрение системы контроля качества.</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Финансовые риски -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="financialRiskHeading">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#financialRiskCollapse" aria-expanded="false" aria-controls="financialRiskCollapse">
                                                        <span class="risk-badge risk-high">Высокий</span> Финансовые риски
                                                    </button>
                                                </h2>
                                                <div id="financialRiskCollapse" class="accordion-collapse collapse" aria-labelledby="financialRiskHeading" data-bs-parent="#riskAccordion">
                                                    <div class="accordion-body">
                                                        <p><strong>Описание:</strong> Недостаток оборотных средств, колебания валютных курсов, рост процентных ставок.</p>
                                                        <p><strong>Меры:</strong> Создание финансового резерва, гибкая ценовая политика, хеджирование финансовых рисков.</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Рыночные риски -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="marketRiskHeading">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#marketRiskCollapse" aria-expanded="false" aria-controls="marketRiskCollapse">
                                                        <span class="risk-badge risk-medium">Средний</span> Рыночные риски
                                                    </button>
                                                </h2>
                                                <div id="marketRiskCollapse" class="accordion-collapse collapse" aria-labelledby="marketRiskHeading" data-bs-parent="#riskAccordion">
                                                    <div class="accordion-body">
                                                        <p><strong>Описание:</strong> Появление новых конкурентов, изменение потребительских предпочтений, снижение спроса.</p>
                                                        <p><strong>Меры:</strong> Регулярный анализ рынка, дифференциация продукта, гибкая маркетинговая стратегия.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="risk-summary-card">
                                    <div class="risk-summary-header">
                                        <h5>Общая оценка рисков для типа бизнеса "{{ result.business_type }}"</h5>
                                    </div>
                                    <div class="risk-summary-body">
                                        <div class="risk-meter-container">
                                            <div class="risk-meter">
                                                <div class="risk-meter-scale">
                                                    <div class="risk-meter-segment very-low"></div>
                                                    <div class="risk-meter-segment low"></div>
                                                    <div class="risk-meter-segment medium"></div>
                                                    <div class="risk-meter-segment high"></div>
                                                    <div class="risk-meter-segment critical"></div>
                                                </div>
                                                <div class="risk-meter-indicator" style="left: 65%;"></div>
                                                <div class="risk-meter-labels">
                                                    <span>Низкий</span>
                                                    <span>Средний</span>
                                                    <span>Высокий</span>
                                                </div>
                                            </div>
                                        </div>
                                        <p class="risk-conclusion">
                                            Для данного типа бизнеса выявлен <strong>повышенный уровень рисков</strong>. 
                                            Рекомендуется уделить особое внимание операционным и финансовым аспектам проекта, 
                                            а также разработать детальный план управления рисками.
                                        </p>
                                        <div class="risk-strategies">
                                            <h6><i class="fas fa-tasks me-2"></i>Рекомендуемые стратегии управления рисками:</h6>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="strategy-card">
                                                        <div class="strategy-icon"><i class="fas fa-random"></i></div>
                                                        <div class="strategy-name">Диверсификация</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="strategy-card">
                                                        <div class="strategy-icon"><i class="fas fa-umbrella"></i></div>
                                                        <div class="strategy-name">Страхование</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="strategy-card">
                                                        <div class="strategy-icon"><i class="fas fa-clipboard-check"></i></div>
                                                        <div class="strategy-name">Мониторинг</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="bank-integration mt-4">
                        <h3 class="mb-3">Финансирование бизнеса</h3>
                        
                        <div class="row mb-4">
                            <div class="col-md-5">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-percentage me-2"></i>Актуальные кредитные ставки</h5>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="bank-rates-loading text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Загрузка...</span>
                                            </div>
                                            <p class="mt-2">Получение актуальных ставок...</p>
                                        </div>
                                        
                                        <div class="bank-rates-container d-none">
                                            <div class="best-rate-banner p-3 bg-light border-bottom">
                                                <div class="d-flex align-items-center">
                                                    <div class="best-rate-badge me-3">
                                                        <i class="fas fa-award fs-3 text-warning"></i>
                                                    </div>
                                                    <div>
                                                        <p class="mb-0">Лучшая ставка:</p>
                                                        <h5 class="best-rate-value text-success mb-0"></h5>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="bank-list">
                                                <!-- Банки будут добавлены динамически -->
                                            </div>
                                            
                                            <div class="bank-rates-footer p-2 text-center">
                                                <small class="text-muted">Ставки обновлены: <span class="rates-updated-time"></span></small>
                                                <button class="btn btn-sm btn-outline-primary ms-2 refresh-rates-btn">
                                                    <i class="fas fa-sync-alt me-1"></i>Обновить
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="bank-rates-error d-none p-3 text-center text-danger">
                                            <i class="fas fa-exclamation-circle fs-4 mb-2"></i>
                                            <p>Не удалось загрузить данные о кредитных ставках.</p>
                                            <button class="btn btn-sm btn-outline-danger refresh-rates-btn">
                                                <i class="fas fa-sync-alt me-1"></i>Повторить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-7">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Кредитный калькулятор</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="loanCalculatorForm" class="loan-calculator">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="loanAmount" class="form-label">Сумма кредита (руб.)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="loanAmount" value="{{ result.price }}" min="100000" step="10000">
                                                        <span class="input-group-text">₽</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="interestRate" class="form-label">Процентная ставка (%)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="interestRate" value="10.5" min="1" max="30" step="0.1">
                                                        <span class="input-group-text">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="loanTerm" class="form-label">Срок кредита (лет)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="loanTerm" value="3" min="1" max="20" step="1">
                                                        <span class="input-group-text">лет</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 d-flex align-items-end">
                                                    <button type="submit" class="btn btn-primary btn-block w-100">
                                                        <i class="fas fa-calculator me-2"></i>Рассчитать
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                        
                                        <div class="loan-results mt-4 d-none">
                                            <h5 class="loan-results-title mb-3">Результаты расчета</h5>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="loan-result-item">
                                                        <div class="loan-result-label">Ежемесячный платеж:</div>
                                                        <div class="loan-result-value monthly-payment">-</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="loan-result-item">
                                                        <div class="loan-result-label">Количество платежей:</div>
                                                        <div class="loan-result-value total-payments">-</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="loan-result-item">
                                                        <div class="loan-result-label">Общая сумма выплат:</div>
                                                        <div class="loan-result-value total-payment">-</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="loan-result-item">
                                                        <div class="loan-result-label">Переплата по кредиту:</div>
                                                        <div class="loan-result-value total-interest">-</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="loan-error mt-3 d-none">
                                            <div class="alert alert-danger mb-0">
                                                <i class="fas fa-exclamation-circle me-2"></i>
                                                <span class="loan-error-message">Ошибка при расчете кредита.</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="loan-comparison mt-3 d-none">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-balance-scale me-2"></i>Сравнение кредитных предложений</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Банк</th>
                                                    <th>Ставка</th>
                                                    <th>Ежемесячный платеж</th>
                                                    <th>Общая сумма выплат</th>
                                                    <th>Переплата</th>
                                                    <th>Срок</th>
                                                </tr>
                                            </thead>
                                            <tbody class="loan-comparison-tbody">
                                                <!-- Данные будут добавлены динамически -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer text-muted">
                                    <small>* Расчет является приблизительным. Для получения точных условий обратитесь напрямую в банк.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons mt-5 text-center">
                        <a href="{{ url_for('constructor') }}" class="btn btn-outline-primary btn-lg me-3">
                            <i class="fas fa-edit me-2"></i>Изменить параметры
                        </a>
                        <a href="/download-pdf" class="btn btn-success btn-lg" id="downloadPdfBtn">
                            <i class="fas fa-file-pdf me-2"></i>Скачать бизнес-план
                        </a>
                    </div>
                    
                    <!-- Контейнер для уведомлений о PDF -->
                    <div id="pdfNotifications" class="mt-3"></div>
                </div>
            </div>
            
            <div class="next-steps mt-4 text-center" data-aos="fade-up" data-aos-delay="100">
                <p class="mb-2">Нужна помощь в реализации вашего бизнес-плана?</p>
                <a href="{{ url_for('contact') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-headset me-2"></i>Получить консультацию специалиста
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Анимация цены при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        const priceElement = document.querySelector('.animated-price');
        // Получаем числовое значение цены из текста, удаляя нечисловые символы
        const priceText = priceElement.textContent.trim();
        const finalPrice = parseInt(priceText.replace(/\D/g, ''));
        
        let startPrice = 0;
        const duration = 1500; // длительность анимации в мс
        const startTime = performance.now();
        
        function animatePrice(currentTime) {
            const elapsedTime = currentTime - startTime;
            const progress = Math.min(elapsedTime / duration, 1);
            
            // Функция плавности
            const easeOutQuad = t => t * (2 - t);
            const easedProgress = easeOutQuad(progress);
            
            const currentPrice = Math.floor(startPrice + (finalPrice - startPrice) * easedProgress);
            // Форматируем число с пробелами между разрядами (русский формат)
            priceElement.textContent = currentPrice.toLocaleString('ru-RU') + ' руб.';
            
            if (progress < 1) {
                requestAnimationFrame(animatePrice);
            }
        }
        
        requestAnimationFrame(animatePrice);
    });
    
    // Обработчик для кнопки скачивания PDF
    document.getElementById('downloadPdfBtn').addEventListener('click', function(e) {
        e.preventDefault(); // Предотвращаем стандартное поведение ссылки
        console.log('Начинаем процесс скачивания PDF...');
        
        // Показываем индикатор загрузки
        showNotification('info', 'Подготавливаем PDF, пожалуйста, подождите...');
        
        // Получаем URL для скачивания
        const downloadUrl = this.getAttribute('href');
        console.log('URL для скачивания:', downloadUrl);
        
        // Ещё один подход - прямая загрузка через fetch
        fetch(downloadUrl)
            .then(response => {
                console.log('HTTP статус:', response.status);
                console.log('Заголовки ответа:', Array.from(response.headers.entries()));
                
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP ошибка! Статус: ${response.status}, Сообщение: ${text}`);
                    });
                }
                
                // Проверяем content-type
                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);
                
                if (contentType && contentType.includes('application/pdf')) {
                    return response.blob();
                } else {
                    // Если это не PDF, читаем текст ответа для отображения ошибки
                    return response.text().then(text => {
                        throw new Error(`Ответ не является PDF файлом: ${text}`);
                    });
                }
            })
            .then(blob => {
                console.log('Получен blob, тип:', blob.type, 'размер:', blob.size);
                
                if (blob.size < 100) {
                    // Если получен слишком маленький файл, это может быть текстовое сообщение об ошибке
                    return blob.text().then(text => {
                        throw new Error(`Ошибка генерации PDF: ${text}`);
                    });
                }
                
                // Создаем ссылку для скачивания
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'business_plan.pdf';
                document.body.appendChild(a);
                
                // Попытка скачивания
                try {
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('success', 'PDF успешно загружен!');
                } catch (error) {
                    console.error('Ошибка при клике на ссылку:', error);
                    document.body.removeChild(a);
                    showNotification('warning', 'Возникла проблема при скачивании. Попробуйте открыть PDF в новой вкладке.');
                    
                    // Открытие в новой вкладке как запасной вариант
                    window.open(url, '_blank');
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке PDF:', error);
                showNotification('danger', `Не удалось загрузить PDF: ${error.message}. Пожалуйста, попробуйте снова.`);
                
                // Пытаемся открыть в новой вкладке как запасной вариант
                setTimeout(() => {
                    window.open(downloadUrl, '_blank');
                }, 1000);
            });
        
        // Функция для отображения уведомлений
        function showNotification(type, message) {
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                </div>
            `;
            
            const notificationsContainer = document.getElementById('pdfNotifications');
            notificationsContainer.innerHTML = alertHTML;
            
            // Автоматически скрываем уведомление успеха через 5 секунд
            if (type === 'success') {
                setTimeout(function() {
                    const alertElement = notificationsContainer.querySelector('.alert');
                    if (alertElement) {
                        const alert = new bootstrap.Alert(alertElement);
                        alert.close();
                    }
                }, 5000);
            }
        }
    });
    
    // Банковская интеграция - получение актуальных кредитных ставок
    function loadBankRates(forceRefresh = false) {
        // Показываем индикатор загрузки
        document.querySelector('.bank-rates-loading').classList.remove('d-none');
        document.querySelector('.bank-rates-container').classList.add('d-none');
        document.querySelector('.bank-rates-error').classList.add('d-none');
        
        // Делаем запрос к API
        const url = `/api/bank-rates${forceRefresh ? '?force_refresh=true' : ''}`;
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ошибка! Статус: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Скрываем индикатор загрузки
                document.querySelector('.bank-rates-loading').classList.add('d-none');
                document.querySelector('.bank-rates-container').classList.remove('d-none');
                
                // Отображаем данные банков
                renderBankRates(data);
                
                // Обновляем дату обновления ставок
                const now = new Date();
                document.querySelector('.rates-updated-time').textContent = now.toLocaleString();
            })
            .catch(error => {
                console.error('Ошибка при загрузке кредитных ставок:', error);
                
                // Скрываем индикатор загрузки и показываем ошибку
                document.querySelector('.bank-rates-loading').classList.add('d-none');
                document.querySelector('.bank-rates-error').classList.remove('d-none');
            });
    }
    
    // Отображение данных о кредитных ставках
    function renderBankRates(data) {
        const bankList = document.querySelector('.bank-list');
        const rates = data.rates;
        const best = data.best;
        
        // Очищаем список банков
        bankList.innerHTML = '';
        
        // Отображаем лучшую ставку
        document.querySelector('.best-rate-value').textContent = `${best.name}: ${best.min_rate}%`;
        
        // Добавляем каждый банк в список
        rates.forEach(bank => {
            const bankItem = document.createElement('div');
            bankItem.className = 'bank-item';
            
            // Путь к логотипу
            const logoPath = `/static/images/banks/${bank.logo}`;
            
            bankItem.innerHTML = `
                <div class="d-flex align-items-center">
                    <img src="${logoPath}" alt="${bank.name}" class="bank-logo me-3" onerror="this.src='/static/images/banks/default_bank.png'">
                    <div>
                        <div class="bank-name">${bank.name}</div>
                        <div class="bank-rate">${bank.min_rate}% - ${bank.max_rate}%</div>
                        <div class="bank-term">${bank.loan_term}</div>
                    </div>
                </div>
            `;
            
            // Добавляем обработчик для выбора этой ставки в калькуляторе
            bankItem.addEventListener('click', function() {
                // Устанавливаем минимальную ставку этого банка в калькулятор
                document.getElementById('interestRate').value = bank.min_rate;
                // Если есть активные результаты, пересчитываем кредит
                if (!document.querySelector('.loan-results').classList.contains('d-none')) {
                    calculateLoan();
                }
            });
            
            bankList.appendChild(bankItem);
        });
        
        // Если у нас есть данные для калькулятора, обновляем таблицу сравнения
        if (!document.querySelector('.loan-results').classList.contains('d-none')) {
            updateLoanComparison(rates);
        }
    }
    
    // Расчет кредита
    function calculateLoan() {
        // Получаем значения из формы
        const loanAmount = parseFloat(document.getElementById('loanAmount').value);
        const interestRate = parseFloat(document.getElementById('interestRate').value);
        const loanTerm = parseFloat(document.getElementById('loanTerm').value);
        
        // Проверяем валидность данных
        if (isNaN(loanAmount) || isNaN(interestRate) || isNaN(loanTerm) || 
            loanAmount <= 0 || interestRate < 0 || loanTerm <= 0) {
            showLoanError('Пожалуйста, введите корректные значения для расчета.');
            return;
        }
        
        // Скрываем сообщение об ошибке, если оно было
        document.querySelector('.loan-error').classList.add('d-none');
        
        // Отправляем запрос к API для расчета кредита
        fetch('/api/calculate-loan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                loan_amount: loanAmount,
                interest_rate: interestRate,
                loan_term_years: loanTerm
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Ошибка при расчете кредита');
                });
            }
            return response.json();
        })
        .then(data => {
            // Отображаем результаты расчета
            document.querySelector('.loan-results').classList.remove('d-none');
            
            // Форматирование чисел для отображения
            const formatter = new Intl.NumberFormat('ru-RU');
            
            document.querySelector('.monthly-payment').textContent = formatter.format(data.monthly_payment) + ' руб.';
            document.querySelector('.total-payments').textContent = data.total_payments;
            document.querySelector('.total-payment').textContent = formatter.format(data.total_payment) + ' руб.';
            document.querySelector('.total-interest').textContent = formatter.format(data.total_interest) + ' руб.';
            
            // Обновляем таблицу сравнения, если у нас есть данные о ставках
            if (!document.querySelector('.bank-rates-container').classList.contains('d-none')) {
                // Получаем данные о ставках
                fetch('/api/bank-rates')
                    .then(response => response.json())
                    .then(bankData => {
                        updateLoanComparison(bankData.rates);
                    })
                    .catch(error => {
                        console.error('Ошибка при загрузке ставок для сравнения:', error);
                    });
            }
        })
        .catch(error => {
            showLoanError(error.message);
        });
    }
    
    // Отображение ошибки расчета кредита
    function showLoanError(message) {
        const errorElement = document.querySelector('.loan-error');
        errorElement.classList.remove('d-none');
        errorElement.querySelector('.loan-error-message').textContent = message;
    }
    
    // Обновление таблицы сравнения кредитных предложений
    function updateLoanComparison(rates) {
        // Получаем текущие параметры кредита
        const loanAmount = parseFloat(document.getElementById('loanAmount').value);
        const loanTerm = parseFloat(document.getElementById('loanTerm').value);
        
        if (isNaN(loanAmount) || isNaN(loanTerm) || rates.length === 0) {
            return;
        }
        
        // Отображаем секцию сравнения
        document.querySelector('.loan-comparison').classList.remove('d-none');
        
        const tbody = document.querySelector('.loan-comparison-tbody');
        tbody.innerHTML = '';
        
        // Создаем массив для сортировки банков по месячному платежу
        const bankComparisons = [];
        
        // Для каждого банка рассчитываем параметры кредита
        rates.forEach(bank => {
            // Используем минимальную ставку банка
            const rate = bank.min_rate;
            
            // Расчет платежа
            const monthlyRate = rate / 100 / 12;
            const totalPayments = loanTerm * 12;
            let monthlyPayment;
            
            if (monthlyRate === 0) {
                monthlyPayment = loanAmount / totalPayments;
            } else {
                monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalPayments)) / (Math.pow(1 + monthlyRate, totalPayments) - 1);
            }
            
            const totalPayment = monthlyPayment * totalPayments;
            const totalInterest = totalPayment - loanAmount;
            
            bankComparisons.push({
                name: bank.name,
                rate: rate,
                monthlyPayment: monthlyPayment,
                totalPayment: totalPayment,
                totalInterest: totalInterest,
                loanTerm: bank.loan_term
            });
        });
        
        // Сортировка по месячному платежу (от меньшего к большему)
        bankComparisons.sort((a, b) => a.monthlyPayment - b.monthlyPayment);
        
        // Форматирование чисел
        const formatter = new Intl.NumberFormat('ru-RU');
        
        // Добавляем строки в таблицу
        bankComparisons.forEach((bank, index) => {
            const row = document.createElement('tr');
            
            // Лучшему предложению добавляем класс
            if (index === 0) {
                row.classList.add('best-option');
            }
            
            row.innerHTML = `
                <td>${bank.name}</td>
                <td>${bank.rate}%</td>
                <td>${formatter.format(bank.monthlyPayment.toFixed(2))} руб.</td>
                <td>${formatter.format(bank.totalPayment.toFixed(2))} руб.</td>
                <td>${formatter.format(bank.totalInterest.toFixed(2))} руб.</td>
                <td>${bank.loanTerm}</td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    // Обработчик формы калькулятора
    document.getElementById('loanCalculatorForm').addEventListener('submit', function(e) {
        e.preventDefault();
        calculateLoan();
    });
    
    // Обработчик кнопки обновления ставок
    document.querySelectorAll('.refresh-rates-btn').forEach(button => {
        button.addEventListener('click', function() {
            loadBankRates(true);
        });
    });
    
    // Загружаем кредитные ставки при загрузке страницы
    loadBankRates();
</script>
{% endblock %} 