{% extends "base.html" %}

{% block title %}Результаты расчета - Бизнес Конструктор{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}">
<style>
    /* Стили для раздела прогноза окупаемости */
    .roi-prediction .card {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .roi-prediction .card:hover {
        transform: translateY(-5px);
    }
    
    .roi-prediction table {
        margin-bottom: 0;
    }
    
    .roi-prediction th {
        font-weight: 600;
    }
    
    .factors-list {
        padding-left: 0;
        list-style-type: none;
    }
    
    .factors-list li {
        border-bottom: 1px solid #eee;
        padding: 10px 0;
    }
    
    .factors-list li:last-child {
        border-bottom: none;
    }
    
    .factors-list li strong {
        display: block;
        margin-bottom: 5px;
        color: #0d6efd;
    }
    
    .factors-list li p {
        margin-bottom: 0;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="result-container" data-aos="fade-up">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card result-card shadow-lg">
                <div class="card-header bg-success text-white p-4">
                    <h2 class="mb-0"><i class="fas fa-check-circle me-2"></i>Ваш бизнес-план готов!</h2>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-success mb-4" role="alert">
                        <i class="fas fa-info-circle me-2"></i> Ваш бизнес-план был успешно рассчитан. Ниже представлены детали вашего проекта.
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h3 class="mb-4">Детали бизнес-проекта</h3>
                            
                            <div class="details-container">
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-store"></i>
                                    </div>
                                    <div class="detail-content">
                                        <h5>Тип бизнеса</h5>
                                        <p>{{ result.business_type }}</p>
                                    </div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-expand-arrows-alt"></i>
                                    </div>
                                    <div class="detail-content">
                                        <h5>Размер бизнеса</h5>
                                        <p>{{ result.business_size }}</p>
                                    </div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-icon">
                                        <i class="fas fa-list-ul"></i>
                                    </div>
                                    <div class="detail-content">
                                        <h5>Выбранные функции</h5>
                                        {% if result.features %}
                                        <ul class="feature-list">
                                            {% for feature in result.features %}
                                            <li>{{ feature }}</li>
                                            {% endfor %}
                                        </ul>
                                        {% else %}
                                        <p>Дополнительные функции не выбраны</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="price-summary" style="background-color: #0d6efd;">
                                <div class="price-header">
                                    <h3>Итоговая стоимость</h3>
                                </div>
                                <div class="price-value animated-price" style="color: white;">
                                    {{ result.price|number_format }} руб.
                                </div>
                                <div class="price-info">
                                    <p><i class="fas fa-info-circle me-2"></i>Полная стоимость запуска бизнес-проекта</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="recommendations mt-4">
                        <h3 class="mb-3">Рекомендации</h3>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="recommendation-card">
                                    <div class="recommendation-icon">
                                        <i class="fas fa-rocket"></i>
                                    </div>
                                    <h5>Запуск</h5>
                                    <p>Оптимальный срок запуска: <strong>2-3 месяца</strong></p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="recommendation-card">
                                    <div class="recommendation-icon">
                                        <i class="fas fa-hand-holding-usd"></i>
                                    </div>
                                    <h5>Окупаемость</h5>
                                    <p>Ожидаемый срок окупаемости: <strong>12-18 месяцев</strong></p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="recommendation-card">
                                    <div class="recommendation-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h5>Персонал</h5>
                                    <p>Рекомендуемый штат: <strong>5-7 человек</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cost-breakdown mt-4">
                        <h3 class="mb-3">Детализация расходов</h3>
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Категория затрат</th>
                                        <th>Сумма (руб.)</th>
                                        <th>Доля (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set total = result.price %}
                                    {% if result.cost_breakdown %}
                                        {% for category, amount in result.cost_breakdown.items() %}
                                        <tr>
                                            <td>{{ category }}</td>
                                            <td>{{ amount|number_format }}</td>
                                            <td>{{ ((amount / total) * 100)|round(1) }}%</td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        {% set equipment_cost = (total * 0.35)|round|int %}
                                        {% set rent_cost = (total * 0.15)|round|int %}
                                        {% set personnel_cost = (total * 0.25)|round|int %}
                                        {% set marketing_cost = (total * 0.10)|round|int %}
                                        {% set other_cost = total - equipment_cost - rent_cost - personnel_cost - marketing_cost %}
                                        <tr>
                                            <td>Оборудование и техника</td>
                                            <td>{{ equipment_cost|number_format }}</td>
                                            <td>35%</td>
                                        </tr>
                                        <tr>
                                            <td>Аренда помещения</td>
                                            <td>{{ rent_cost|number_format }}</td>
                                            <td>15%</td>
                                        </tr>
                                        <tr>
                                            <td>Персонал и зарплаты</td>
                                            <td>{{ personnel_cost|number_format }}</td>
                                            <td>25%</td>
                                        </tr>
                                        <tr>
                                            <td>Маркетинг и реклама</td>
                                            <td>{{ marketing_cost|number_format }}</td>
                                            <td>10%</td>
                                        </tr>
                                        <tr>
                                            <td>Прочие расходы</td>
                                            <td>{{ other_cost|number_format }}</td>
                                            <td>15%</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                                <tfoot class="table-secondary">
                                    <tr>
                                        <th>Итого</th>
                                        <th>{{ result.price|number_format }}</th>
                                        <th>100%</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-8 offset-md-2">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-info-circle me-2"></i>Важная информация
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">
                                            Представленная разбивка стоимости отражает приблизительное распределение затрат для выбранного типа бизнеса. 
                                            Фактические расходы могут отличаться в зависимости от региона, выбранных поставщиков и текущих рыночных условий.
                                        </p>
                                        <p class="card-text mb-0">
                                            Более подробный анализ расходов доступен в PDF-версии бизнес-плана.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="roi-prediction mt-4">
                        <h3 class="mb-3">Прогноз окупаемости инвестиций</h3>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Ключевые показатели окупаемости</h5>
                                    </div>
                                    <div class="card-body">
                                        {% set total_investment = result.price %}
                                        {% set monthly_revenue = (total_investment * 0.15)|round|int %}
                                        {% set monthly_expenses = (monthly_revenue * 0.7)|round|int %}
                                        {% set monthly_profit = monthly_revenue - monthly_expenses %}
                                        {% set months_to_roi = (total_investment / monthly_profit)|round|int %}
                                        
                                        <table class="table table-hover">
                                            <tbody>
                                                <tr>
                                                    <th>Общие инвестиции</th>
                                                    <td class="text-end">{{ total_investment|number_format }} руб.</td>
                                                </tr>
                                                <tr>
                                                    <th>Прогнозируемый ежемесячный доход</th>
                                                    <td class="text-end">{{ monthly_revenue|number_format }} руб.</td>
                                                </tr>
                                                <tr>
                                                    <th>Прогнозируемые ежемесячные расходы</th>
                                                    <td class="text-end">{{ monthly_expenses|number_format }} руб.</td>
                                                </tr>
                                                <tr>
                                                    <th>Прогнозируемая ежемесячная прибыль</th>
                                                    <td class="text-end">{{ monthly_profit|number_format }} руб.</td>
                                                </tr>
                                                <tr class="table-primary">
                                                    <th>Расчетный срок окупаемости</th>
                                                    <td class="text-end fw-bold">{{ months_to_roi }} месяцев</td>
                                                </tr>
                                                <tr>
                                                    <th>Прогнозируемая годовая доходность (ROI)</th>
                                                    <td class="text-end">{{ ((monthly_profit * 12 / total_investment) * 100)|round|int }}%</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Факторы, влияющие на окупаемость</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="factors-list">
                                            <li>
                                                <strong>Расположение</strong>
                                                <p>Выбор правильного местоположения может сократить срок окупаемости на 20-30%</p>
                                            </li>
                                            <li>
                                                <strong>Маркетинговая стратегия</strong>
                                                <p>Эффективная маркетинговая стратегия обеспечивает более быстрый рост клиентской базы</p>
                                            </li>
                                            <li>
                                                <strong>Сезонность</strong>
                                                <p>Учитывайте сезонные колебания спроса при планировании денежных потоков</p>
                                            </li>
                                            <li>
                                                <strong>Конкурентная среда</strong>
                                                <p>Анализ конкурентов поможет выбрать правильное позиционирование на рынке</p>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Примечание:</strong> Расчет основан на среднерыночных показателях и может отличаться в зависимости от региона и текущей экономической ситуации. Рекомендуется провести дополнительный анализ с учетом специфики вашего бизнеса.
                        </div>
                    </div>
                    
                    <div class="action-buttons mt-5 text-center">
                        <a href="{{ url_for('constructor') }}" class="btn btn-outline-primary btn-lg me-3">
                            <i class="fas fa-edit me-2"></i>Изменить параметры
                        </a>
                        <a href="/download-pdf" class="btn btn-success btn-lg" id="downloadPdfBtn">
                            <i class="fas fa-file-pdf me-2"></i>Скачать бизнес-план
                        </a>
                    </div>
                    
                    <!-- Контейнер для уведомлений о PDF -->
                    <div id="pdfNotifications" class="mt-3"></div>
                </div>
            </div>
            
            <div class="next-steps mt-4 text-center" data-aos="fade-up" data-aos-delay="100">
                <p class="mb-2">Нужна помощь в реализации вашего бизнес-плана?</p>
                <a href="{{ url_for('contact') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-headset me-2"></i>Получить консультацию специалиста
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Анимация цены при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        const priceElement = document.querySelector('.animated-price');
        // Получаем числовое значение цены из текста, удаляя нечисловые символы
        const priceText = priceElement.textContent.trim();
        const finalPrice = parseInt(priceText.replace(/\D/g, ''));
        
        let startPrice = 0;
        const duration = 1500; // длительность анимации в мс
        const startTime = performance.now();
        
        function animatePrice(currentTime) {
            const elapsedTime = currentTime - startTime;
            const progress = Math.min(elapsedTime / duration, 1);
            
            // Функция плавности
            const easeOutQuad = t => t * (2 - t);
            const easedProgress = easeOutQuad(progress);
            
            const currentPrice = Math.floor(startPrice + (finalPrice - startPrice) * easedProgress);
            // Форматируем число с пробелами между разрядами (русский формат)
            priceElement.textContent = currentPrice.toLocaleString('ru-RU') + ' руб.';
            
            if (progress < 1) {
                requestAnimationFrame(animatePrice);
            }
        }
        
        requestAnimationFrame(animatePrice);
    });
    
    // Обработчик для кнопки скачивания PDF
    document.getElementById('downloadPdfBtn').addEventListener('click', function(e) {
        e.preventDefault(); // Предотвращаем стандартное поведение ссылки
        console.log('Начинаем процесс скачивания PDF...');
        
        // Показываем индикатор загрузки
        showNotification('info', 'Подготавливаем PDF, пожалуйста, подождите...');
        
        // Получаем URL для скачивания
        const downloadUrl = this.getAttribute('href');
        console.log('URL для скачивания:', downloadUrl);
        
        // Ещё один подход - прямая загрузка через fetch
        fetch(downloadUrl)
            .then(response => {
                console.log('HTTP статус:', response.status);
                console.log('Заголовки ответа:', Array.from(response.headers.entries()));
                
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP ошибка! Статус: ${response.status}, Сообщение: ${text}`);
                    });
                }
                
                // Проверяем content-type
                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);
                
                if (contentType && contentType.includes('application/pdf')) {
                    return response.blob();
                } else {
                    // Если это не PDF, читаем текст ответа для отображения ошибки
                    return response.text().then(text => {
                        throw new Error(`Ответ не является PDF файлом: ${text}`);
                    });
                }
            })
            .then(blob => {
                console.log('Получен blob, тип:', blob.type, 'размер:', blob.size);
                
                if (blob.size < 100) {
                    // Если получен слишком маленький файл, это может быть текстовое сообщение об ошибке
                    return blob.text().then(text => {
                        throw new Error(`Ошибка генерации PDF: ${text}`);
                    });
                }
                
                // Создаем ссылку для скачивания
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'business_plan.pdf';
                document.body.appendChild(a);
                
                // Попытка скачивания
                try {
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('success', 'PDF успешно загружен!');
                } catch (error) {
                    console.error('Ошибка при клике на ссылку:', error);
                    document.body.removeChild(a);
                    showNotification('warning', 'Возникла проблема при скачивании. Попробуйте открыть PDF в новой вкладке.');
                    
                    // Открытие в новой вкладке как запасной вариант
                    window.open(url, '_blank');
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке PDF:', error);
                showNotification('danger', `Не удалось загрузить PDF: ${error.message}. Пожалуйста, попробуйте снова.`);
                
                // Пытаемся открыть в новой вкладке как запасной вариант
                setTimeout(() => {
                    window.open(downloadUrl, '_blank');
                }, 1000);
            });
        
        // Функция для отображения уведомлений
        function showNotification(type, message) {
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                </div>
            `;
            
            const notificationsContainer = document.getElementById('pdfNotifications');
            notificationsContainer.innerHTML = alertHTML;
            
            // Автоматически скрываем уведомление успеха через 5 секунд
            if (type === 'success') {
                setTimeout(function() {
                    const alertElement = notificationsContainer.querySelector('.alert');
                    if (alertElement) {
                        const alert = new bootstrap.Alert(alertElement);
                        alert.close();
                    }
                }, 5000);
            }
        }
    });
</script>
{% endblock %} 